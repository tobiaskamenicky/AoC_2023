namespace AdventOfCode2023;

public static class Day21
{
    public static void Solve()
    {
        Console.WriteLine("Day 21");
        Console.WriteLine($"Part 1: {Part1()}"); //3562
        Console.WriteLine($"Part 2: {Part2()}"); //592723929260582
    }

    public static long Part1()
    {
        var input = _input.AsSpan();
        var lineLength = input.IndexOf(Environment.NewLine[0]);
        var lineWidth = lineLength + Environment.NewLine.Length;

        var start = input.IndexOf('S');

        var steps = new HashSet<int> {start};

        Span<int> neighbors = stackalloc int[4];
        for (var i = 1; i < 65; i++)
        {
            var newSteps = new HashSet<int>();
            foreach (var step in steps)
            {
                var neighborCount = 0;
                if (step >= lineWidth)
                {
                    neighbors[neighborCount++] = step - lineWidth;
                }

                if (step < input.Length - lineWidth)
                {
                    neighbors[neighborCount++] = step + lineWidth;
                }

                if (step % lineWidth != 0)
                {
                    neighbors[neighborCount++] = step - 1;
                }

                if (step % lineWidth != lineLength - 1)
                {
                    neighbors[neighborCount++] = step + 1;
                }

                for (var nI = 0; nI < neighborCount; ++nI)
                {
                    var neighborIndex = neighbors[nI];
                    if (input[neighborIndex] == '#')
                    {
                        continue;
                    }

                    newSteps.Add(neighborIndex);
                }

                steps = newSteps;
            }
        }

        return steps.Count;
    }

    public static long Part2()
    {
        var input = _input.AsSpan();
        var lineLength = input.IndexOf(Environment.NewLine[0]);
        var lineWidth = lineLength + Environment.NewLine.Length;
        var lineCount = input.Length / lineWidth + 1;

        const int totalSteps = 26501365;

        long repeats = totalSteps / lineCount;
        var remainder = totalSteps % lineCount;

        var start = input.IndexOf('S');
        var steps = new HashSet<(int X, int Y)> {ToCoord(start)};

        Span<long> coef = stackalloc long[3];
        Span<(int X, int Y)> neighbors = stackalloc (int, int)[4];
        var s = 0;
        for (var k = 0; k < 3; k++)
        {
            for (; s < k * lineCount + remainder; s++)
            {
                var newSteps = new HashSet<(int, int)>();
                foreach (var step in steps)
                {
                    var neighborCount = 0;
                    neighbors[neighborCount++] = step with {Y = step.Y - 1};
                    neighbors[neighborCount++] = step with {Y = step.Y + 1};
                    neighbors[neighborCount++] = step with {X = step.X - 1};
                    neighbors[neighborCount++] = step with {X = step.X + 1};

                    for (var nI = 0; nI < neighborCount; ++nI)
                    {
                        var neighborIndex = ToIndex(neighbors[nI]);
                        if (input[neighborIndex] == '#')
                        {
                            continue;
                        }

                        newSteps.Add(neighbors[nI]);
                    }

                    steps = newSteps;
                }
            }

            coef[k] = steps.Count;
        }

        var c = coef[0];
        var a = (coef[2] - c - 2 * (coef[1] - c)) / 2;
        var b = coef[1] - c - a;

        return a * repeats * repeats + b * repeats + c;

        (int X, int Y) ToCoord(int index)
        {
            return (index % lineWidth, index / lineWidth);
        }

        int ToIndex((int X, int Y) coord)
        {
            return (coord.Y % lineCount + lineCount) % lineCount * lineWidth + (coord.X % lineLength + lineLength) % lineLength;
        }
    }

    private const string _testInput = """
                                      ...........
                                      .....###.#.
                                      .###.##..#.
                                      ..#.#...#..
                                      ....#.#....
                                      .##..S####.
                                      .##..#...#.
                                      .......##..
                                      .##.#.####.
                                      .##..##.##.
                                      ...........
                                      """;

    private const string _input = """
                                  ...................................................................................................................................
                                  .......#.......#...#....#.........##.#.#.............#....#.#.............#.#...............#.....#......#.#.............#.........
                                  ....#...........#..##......#.#.....................#....................#.....#............#..#......#...............#.#.........#.
                                  ......................##......#...###.#.#.....#.....#...................#......#.......#...#.......#...............#.............#.
                                  .......#.#.#.....##..##..................#.#...........#..........................#......#..##.#.......#..........#..#.....#..#..#.
                                  ...#..#.......#.....#..#...........#..#.....#.......##......................#............#..........#.#.#.#..#......##.#...........
                                  ..#........#..#..........#...#.......#..#.#..#.##...#.............#..........##.#....#.......#....#......#....#.#......#....#....#.
                                  ..#......#.#...###..#....#.......#...............##...#........#.............#........#.#..####...............#.......##.........#.
                                  ...#.....#..........#..#....#....#..#.....##....#...##........#....#.........#....#.#.##....#.#...#..#........#..##......#.........
                                  ..............#.#.#....#..#...##....#..........#..............#...#...........#............#..........#.#........#..###........#...
                                  ......#..#..#....#.##.###........#.....#.....................#..#.#.#.#..............#....#.............#...#........#....#...#....
                                  ..#.....#.........#................##......................#.......#....#.......#...#....#............#...#.........##...#......#..
                                  ...#.....................#......#....#...#.....#.#.............#............................#........#....##..##..#.....#...#.#....
                                  .#..#....##.............#.#...#.##..............#.........#...##...#.#..#..........................#.......#.#.....##...#.#...###..
                                  ..##..........#..#...#....#.......#.....##...#.........#.............#.#............#...#.....#.#.###.#.#.#..#..........#...#......
                                  ..#.....##......#...#...###....#.#..........#..........#..........##..#..###........#...............#.....#.#..#...................
                                  .....#..#...................#........#.#.#............#.......##.....................##........#............#......#....####.......
                                  ....#.............##.................................#.#......#....##.##................#..#.........#....#.#.......#.#...#....#.#.
                                  ...#........#...........#........#..#......#.........###..#.............................#...#...........#....#..##...#...#.#.......
                                  ....#.......#..##...............##................#...#..#..#..............#..#.........#.........##.......#...............#.......
                                  .##..#..........#..#........#..##...#...#........#..........##..............####..............#..#.......#...#.#...........#.......
                                  ...#...#....#....#....#.##...........................#......#.....#.....#...#..#.##................#.........#.#..#....#.#..#......
                                  .#.##...#.......#..#....#..#....#......#.........#.#..#...............#....#.#...#..........#...............#.................#....
                                  .....##..#........#........#...#.....##..........#......#..##...#...............................#.#.............#.......##....#....
                                  ......#......#...#.........#...##.#.......................##.#....#..#..###...###............#...........#...#.......#..#.....##...
                                  ...............#.............................##...............#...#................#...........#..................#................
                                  ..#.......#..#...##......####..#..##...................#......#.#.#........#..#...#...................#.......##.......#...##......
                                  ............#..#........#.....#......................#.....#...#..#.#.....#.........#...#.......#................#.......#.........
                                  .#..#......#........#......#.........................##......#.#...#..#.........#.###...#..........#.....................#..#.#....
                                  ..##.#....#.....................#.............#....#.##...####..#.#.#....#....#..........#.............#...##......#.#......#.#..#.
                                  .#...............#.............#.........###..#..#.#..#.##....#....#...#.......#............................#.........#.........##.
                                  .#..##....#..........#.......##.................#.###.#...#...............#.........#.......#.............#...#.#...##......#...##.
                                  .#..#........#..#............................###.......#....#..#.......#..#.....#.........#..#.....................###....#.#.#....
                                  .##.....#...........#.##.##............#.#.........#.##..#......#.................#........#...................#...#.....#..#.#....
                                  ...#.....#.#..##.........#........................#..#...............................#...#...#...........#..#....##...........#....
                                  ...###.....#.......................#......#.........#...#......#......#.#.#....#..#..#.....#..#.#.......#.#......#.##........#.....
                                  ..#........#.....#.......#......................#.......#.#...............#.#............#....#.#........#........#.#..#..#.#..#...
                                  ....#..........#.....##...................#......#........#..#..#.#.............###....##.#..#.........................#.......#...
                                  ..#....#....#....#...............................#.#...........#........#.....#..####....#......................#....#.#...........
                                  .....#.....#...#..............#.#..#........#....#.........#..###..#..#..##..............#..#.....#.#..........#.............##..#.
                                  ....###..............#.........#.....#...#........#.##......#...............#....#..........#.......................#...........#..
                                  .#......#...#.#..#..#.......#..#....#........#..............##.#.........#...##.........#....#...#.#..........###....#..#..#.#...#.
                                  ...........#.....#...............#...........#........#.................#....##...........##......#.................#.#.......#..#.
                                  .#....#...##....##........#...##....#.###....##.................#..........#.........#....##.#...........................#.#.......
                                  ..#...............................###.........#.....#.................#.#........##....#.........##.#.##.............#.......#.##..
                                  .....#............................##.......##.........#.#................#......#.......#................##................#.#.#...
                                  ...#..........#.........#..#...#.....#.............##..........#....................#.....#.....#........#..............##...#..#..
                                  ...#..................#.##.###............#......#....#............#.#.#..#.......#.......#..............#.............#...#.......
                                  ...#...................#.............##...#.#..#....#......#...#......................#...............#.#................#...##....
                                  ..#.......##................#......#.#.........#...#..##....#.........#........#.........#.....##.......#...#..........#.....#.....
                                  ....#................#...#....#....##..#..###....#..............#.#.#.........#....#.##...#...#.....#.......................#....#.
                                  .....#.#..#.................#....#....#...#......##......##..............#................##...#..#......#......#.......#......#...
                                  ......#..........#.#......#.....#.#.#......................#...#...#....#..#...........##.#.......#..##.#..#.......................
                                  .#....#..........#..#....................##.#.....#.........#........#....#....#..#..............#...#...#....#...............##...
                                  .###.#.......................#...............##....#...#....#.#..........#.........#...##.......#....#...##........#..........#....
                                  ...#.#..........#........#............#........##.#..##..............#...#..#..#..#..##..#...........#...#....#.............#..#...
                                  .............#.......#...#.....#.............#.........#.....#.......##............#...##...#.........#.#.#....#..##...............
                                  ..................#...........#.#......#..#..............#.........#...#....#.#.#......#......##.............##....................
                                  ............#...............#.........#.........#......#.....##.....#....#.#..#........#..............#.#.........#....#........#..
                                  ..#............#...#......#.......#..................#.#..#.......#..#...#.............#..#.#.#...........#.##..#.#....#...........
                                  ...........##................##.......#.....#.....#....#..#.....#...#........#.#..........#.....#.#......................#.......#.
                                  ..............##.#...#..........##........#.........##..........#..#.#....#.........................##....##.........##.##.........
                                  ..............##..#.....##.........###................#...#...#....##.##..#....#......#.................#......#....#......#.......
                                  .......#...................#.........##.......#...........#....#....#.#............#.#...................#.....#...###.............
                                  .........#.......##..##.#...#.....##.......#.........###....##....#.........#............#.#..#.#...#....#....#..#.#.####..........
                                  .................................................................S.................................................................
                                  .....#.....#.....#.###....#.......#.#...#.....##.....#..............#...##...........#..#..................#.....#......#....#.....
                                  ...........#........#.....#.#..........##.#......#..#.......#..........#...#........#.#.#.....##.##....#.#.............#...........
                                  ........#.....#...#..#..............#....#.#...###....#...#.#.#....##......#.#..#.........##..#......#...##..........#..#..........
                                  .........#...#..#...................##.....##..#....#.#....#..##.....#..##......###......#....##.#....##..........#..#.............
                                  ........................#......#.#.............#.....#..#....#..#..#........#......#..#..#..#.....#...#.........#....#.#.........#.
                                  ...........#...#......#................#.....##...##.....##..............#.............#.....#....##.....#.#.#....##............#..
                                  .##................................#..#........#.....#.##....##.....#.##.......##.#.....#......#..............#..................#.
                                  ....................#..............##......#..#.....###..............#.#..##..................#.......................#........#...
                                  .............#..#..#..#...................#..#...#.........###..#..#..#....#.#...#...........##..#...#..#.....#.#..................
                                  ...#..........#.#..#..........#...#....#.##.......#........#...#...#..................##...##.........#.........#...........#...#..
                                  ..#............#.................#.....#......#....#.##.....#..#..#..#.....#..###.............#.......#...#.#.....#.............#..
                                  ....##..#.........#.#.....#.......#.#......#.#...#....##.#............#.....##.#.......#...#..................#............#.....#.
                                  ..##.............#.....#..........#.....#.#.............##...#....#....#.#..#...##....##.#...#.....#..#.....#......................
                                  ..#....#..............#.#..........#.#.....#....#....................#...........#.#.......##.#...#.#..........##..............#...
                                  .#........................#.............#....#..#....#.....##.#..........#...........#.#..#...#..#............................##...
                                  ....#......#.......................##...........#..#..#...#....#..#.#..##...#................#........................#.##...#.#...
                                  ...##......##.....................##...........#..................#.....#.........#.......#.#.....#.#...#....#..........#...##.....
                                  ..#...#...#.#................#..#........#.............##...#.......#........#.....#.#.#.......#.#........#.#...............#..#...
                                  .....#......#...............##..........#.....#......###...........#...#.#..#...#.#..#.###......#...#..#.............#........#....
                                  .............#..........#..........#.............###..#........##....#........#.#.#.........#...##......###...........#.....##...#.
                                  ..........#....#............#...............###....#......#.........#...#...#.#..................#..#..................#...#.......
                                  ....#.#.......#..#........#...#..............#....##.##.......#.#.##............##.....##.##.....#..#........................#..#..
                                  ................................###.#.....#....#.....#.....#.#......#......#...............####......................#.............
                                  .#.##.#..##.....#...#.........................#..#...##..............#.#........#.............#................#...#...##....#...#.
                                  ............#..#..#.................#......#..............#.##.......#...........#..#....#..#..#.#............#.......#....#.......
                                  .##...#..##..#..................#.#........#........#......#...##.#..#.#......#.........#..#.......##...............#..........#...
                                  ...##....#.####........#.........#..........##.#..........#.....#....##....#...#......#.###.##.............#.#.#..#................
                                  .##...#.....#.#....#.#...................#....#..#.......#...#..#......#............#...........##............#...#.#.......#..##..
                                  ......#.#..........................................#....###..........##.....#......#...#......#............#.........#.#.#......#..
                                  ..#..#.#...................................#..........#........##...........#.#.........#....#..............#....#...#.........#...
                                  ..#.#..#...#..#....................#.............#..#.........#.......#...............#...#..................#.....#...#..#.###....
                                  ....#..#.......##...........#..........#..#..##.#...#.#...................................#............##.....#...##...........#...
                                  ..#.#.#.#..#..#......#....#..........#...###...........#.....##.........#........#......................#....#...............#.##..
                                  ...#....#.#.....##...#...##.#.#.............##....#............##.....................................##..#......#....#....##...#..
                                  ..#...#.#.........##...........#.......#...........##...#....#..#..#.##....#......#.#..............#..#........#..#...#........#...
                                  ...#.##.#.#.....###....#....#............#...#............#.......#...#..##..#.#..........................#.#.........#.......#....
                                  .#...............#...#...#.#....#.........#.....#..#.........##........#.............##.................#..........#...............
                                  ....#..#.#.#.#...#.........................####........#...#..........#..........#...............#............#.................#..
                                  .#..#.......#...........#..##....................#.#.#.......................................................##.......#............
                                  ....##....##...........#......#....#............#.#..#...##....#.........#.#..#...#..............#.#......#..........##.....#......
                                  .#.........#.#..#...............#.................#.......#............#............#................#........#.#...........#......
                                  ......##...........#...#.##...................#...#..#.#..#.#.#.......#..........##..........#.#.......#.#..........##..#..........
                                  ..#..#..###.##..#..#.....###.....................##.#.....#.#...#.##..........#.................#..#...#.##..###.........##..##....
                                  ......#..#............#..........##....#........#............#.##.#..##...#.....#............#...#....#......#..#.#................
                                  ....#.......#....#.#..##....##......#...............###...........#..##.#.##.#................#.#........#............#...##.....#.
                                  .........##.....#..#.................#............##.#......#............##.#.#..........##....#..##.#........#.......#....#.....#.
                                  .#......#..#.#...#.......#.....##...#...................#.......#...#..#.....#.........#...#.........##.##...............#.##......
                                  ....#........#.....#.....#...#...#..#..#...............#.#......#..#....#..##.#.........#.....#..#..#..........#.#......##....#.#..
                                  .........###.##..#.#.#.#.#.......#....#.....#..........###..#..................................#.#.#...#...##.#..#..........#......
                                  ..#.#.#........#.#.##.#.#.................#...#.........#.....#....#....#...#..........##...#......##....#.............#...........
                                  ...#.##.......##....##.....##........#....#...#.............#......#...#..................#.......#.....#..........#...............
                                  .....#............#..###......#........#.....................#.....#..#...............#.#.........#......#..#.....#..#.....#....#..
                                  ......#............#.............##..#..#.#....#..........##............##...........#............#..#...##..#.....................
                                  ....#..#...........#.....#...................#...#............##...#.............#..#.........#............#..#..#.....#...#...#...
                                  .#.....#.....##.#.###.#.......#...#.##...#.....#...................####.....................................#....#..##.#.........#.
                                  ....#......#......#.............#......#..#.#.#...............#.................##......................#.........##...........##..
                                  .......#.....#......##........#..#.#..#.....#....#................#.##........#.......#.....#.......#...##..#........#......#.##...
                                  .....#.#.............##..#..#.....##.#.#..##....................#.#..............#.#........#.#..#....................#.......#..#.
                                  ..#.....#.#..........#......##.#.....#..........###..#.........#..............#.......................#...##........#..............
                                  .....#..#.#...#.........#..............#.#..##...#..#.........................#..#....##....#.....#.#...###.........#....#..#......
                                  .....##.......###...#...###.###..###..##.#...#.#...#......................#..........#......##....#.....#.........#........#..#.#..
                                  ...#...#.#......##....#.........#.......#.....##.#..##.#........................#.......#..#....###..#..#...#.............#........
                                  ...##.............#.#.............#.##.............#......................#.......#.........#.##....................#.#...##.......
                                  ....#.#.......#..#......#.......#......#.###.....##......#.............#.....#.............#..##.###.......#....#..............#...
                                  ...................................................................................................................................
                                  """;
}
